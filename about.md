# CodeQL導入演習 - 発表資料

## 📋 発表概要
- **発表時間**: 20分
- **発表者**: [あなたの名前]
- **日付**: 2025年7月16日
- **テーマ**: GitHubのCodeQLを使用したセキュリティ脆弱性の発見と修正
- **対象**: 開発チーム・セキュリティ担当者

---

## 🎯 本日の学習目標

### 1. CodeQLとは何か理解する
- 静的解析ツールの基本概念
- GitHubとの統合方法

### 2. セキュリティ脆弱性の発見と修正を体験する
- SQLインジェクション脆弱性の検出
- 実際のコード修正プロセス

### 3. 開発プロセスへの組み込み方法を学ぶ
- プルリクエストでの自動チェック
- チーム開発での活用方法

---

## 📚 CodeQLの基礎知識

### CodeQLとは何か
```
静的解析ツール = コードを実行せずにセキュリティ問題を発見
```

**CodeQLの正式な定義:**
> CodeQLは、セキュリティチェックを自動化するためにGitHubによって開発されたコード分析エンジンです。CodeQLではコードをデータのように扱うため、従来の静的なアナライザーより高い信頼性をもって、コード内の潜在的な脆弱性を見つけることができます。

**主な特徴:**
- ✅ SQLインジェクション検出
- ✅ クロスサイトスクリプティング (XSS) 検出
- ✅ コードインジェクション検出
- ✅ GitHub Actions との統合
- ✅ 多言語サポート (Python, JavaScript, Java, C# など)

### サポートされる言語
CodeQLは以下の言語をサポートしています：
- **C/C++**
- **C#**
- **Go**
- **Java/Kotlin**
- **JavaScript/TypeScript**
- **Python**
- **Ruby**
- **Swift**

### CodeQLの動作原理
1. **CodeQLデータベース生成**: コードベースを表すデータベースを作成
2. **クエリ実行**: データベースに対してCodeQLクエリを実行
3. **結果表示**: 問題を特定し、GitHub上でアラートとして表示

### なぜCodeQLが重要なのか？
- 🔒 **セキュリティ**: 早期に脆弱性を発見
- 💰 **コスト削減**: 本番環境での問題を未然に防ぐ
- 🚀 **効率性**: 自動化された継続的なセキュリティチェック
- 🎯 **高精度**: 従来の静的解析より高い信頼性

---

## ⚙️ CodeQLの設定オプション

### 1. デフォルトセットアップ
**最も簡単な設定方法:**
- リポジトリの Settings → Security → Code security and analysis
- "Set up" → "Default" を選択
- 自動的に適切な設定を構成

**デフォルト設定の内容:**
- 分析する言語の自動選択
- 実行するクエリスイートの選択
- スキャンをトリガーするイベントの設定

### 2. 高度なセットアップ
**より詳細な制御が可能:**
- カスタマイズ可能なワークフローファイル生成
- github/codeql-action を使用
- 手動でのファイン調整が可能

### 3. 外部CIシステムでの実行
**企業環境での活用:**
- CodeQL CLI を外部CI システムで実行
- 結果をGitHubにアップロード
- SARIF形式でのレポート生成

---

## 🛠️ 実践演習の内容

### ステップ1: CodeQLの有効化
```yaml
# .github/workflows/codeql-analysis.yml
name: "CodeQL"
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
```

**学習ポイント:**
- GitHub Actionsとの統合
- デフォルト設定の理解
- スキャン対象言語の設定

**設定手順:**
1. GitHub.com でリポジトリのメインページに移動
2. リポジトリ名の下にある「セキュリティ」を選択
3. 「Set up code scanning」をクリック
4. 「設定」ドロップダウンで「既定」を選択
5. 「CodeQL を有効にする」を選択

### ステップ2: 脆弱性の発見と分析
**発見した脆弱性:**
- SQLインジェクション脆弱性 × 2件
- 場所: `server/routes.py`

**問題のあるコード例:**
```python
# 脆弱性のあるコード
cursor.execute(
    "SELECT * FROM books WHERE name LIKE '%" + name + "%'"
)
```

**CodeQLが提供する情報:**
- 📍 正確な問題箇所
- 🔍 データフローの可視化
- 💡 修正の推奨事項
- 📊 重要度レベル

### ステップ3: 脆弱性の修正
**修正後のコード:**
```python
# セキュアなコード
cursor.execute(
    "SELECT * FROM books WHERE name LIKE %s", name
)
```

**修正のポイント:**
- パラメータ化クエリの使用
- 文字列連結の排除
- SQLインジェクション対策

### ステップ4: プルリクエストでの検証
**プルリクエストでの体験:**
- 🔄 新しい脆弱性を意図的に導入
- ⚠️ CodeQLによる自動検出
- 💬 開発者への通知とコメント

**プルリクエストのトリガー設定:**
```yaml
on:
  pull_request:
    branches: [main]
    paths-ignore:
      - '**/*.md'
      - '**/*.txt'
```

---

## 📊 CodeQLの課金とパフォーマンス

### Actions の課金について
- **パブリックリポジトリ**: 無料
- **プライベートリポジトリ**: 月次無料枠あり
- **セルフホステッドランナー**: 無料
- **GitHub Enterprise**: CodeQLが含まれており、追加費用なし

### スキャン頻度の最適化
```yaml
on:
  push:
    branches: [main, protected]
  pull_request:
    branches: [main]
  schedule:
    - cron: '20 14 * * 1'  # 毎週月曜日 14:20 UTC
```

**推奨設定:**
- プッシュ時: メインブランチと保護ブランチ
- プルリクエスト時: メインブランチ対象
- スケジュール: 週1回の定期実行

---

## 📊 演習の成果

### Before (修正前)
- ❌ SQLインジェクション脆弱性: 2件
- ❌ セキュリティリスク: 高

### After (修正後)  
- ✅ 脆弱性: 0件
- ✅ セキュリティリスク: なし
- ✅ 自動チェック体制: 構築完了

### 実際の画面キャプチャ
```
Security タブ → Code scanning
- Open alerts: 0
- Closed alerts: 2
- Status: ✅ 問題なし
```

---

## 🏢 チーム開発での活用方法

### 1. 開発フローへの組み込み
```
コード作成 → プルリクエスト → CodeQL自動スキャン → レビュー → マージ
```

### 2. 継続的なセキュリティチェック
- 📅 定期的な全体スキャン
- 🔍 新しい脆弱性パターンの自動検出
- 📈 セキュリティ品質の向上

### 3. チーム内でのベストプラクティス
- 🎯 **教育効果**: 開発者のセキュリティ意識向上
- 📚 **知識共有**: 脆弱性パターンの共有
- 🛡️ **品質保証**: 一貫したセキュリティ基準

---

## 💡 学習のポイント

### 技術的な学び
1. **静的解析の重要性**: コード実行前の問題発見
2. **自動化の価値**: 人的ミスの削減
3. **継続的セキュリティ**: DevSecOpsの実践

### プロセス面での学び
1. **早期発見**: 開発初期での問題特定
2. **コスト効率**: 修正コストの削減
3. **品質向上**: セキュリティ品質の標準化

### チーム運営での学び
1. **透明性**: 問題の可視化
2. **協力**: チーム全体でのセキュリティ取り組み
3. **継続改善**: 継続的な品質向上

---

## 🚀 次のステップ

### 短期的な取り組み
- [ ] 既存プロジェクトでのCodeQL導入
- [ ] チーム内でのCodeQLトレーニング
- [ ] セキュリティチェックリストの作成

### 長期的な取り組み
- [ ] セキュリティ品質メトリクスの定義
- [ ] 他のセキュリティツールとの統合
- [ ] セキュリティ文化の醸成

---

## 📖 参考資料

### 公式ドキュメント
- [GitHub Code Scanning](https://docs.github.com/en/code-security/code-scanning)
- [CodeQL Documentation](https://codeql.github.com/docs/)

### 学習リソース
- [GitHub Skills: CodeQL](https://skills.github.com/)
- [セキュリティベストプラクティス](https://docs.github.com/en/code-security)

---

## 🤝 質疑応答

### よくある質問

**Q1: CodeQLの導入コストは？**
A: 
- パブリックリポジトリ: 完全無料
- プライベートリポジトリ: 月次無料枠あり
- GitHub Enterprise: 追加費用なし

**Q2: 既存プロジェクトでの導入は大変？**
A: 
- 設定は非常に簡単（数クリックで完了）
- 段階的な導入が可能
- 既存のCIパイプラインとの統合も容易

**Q3: false positiveは多い？**
A: 
- 高精度で誤検出は最小限
- 適切な設定で更に削減可能
- 継続的な学習により精度向上

**Q4: SARIFファイルの活用法は？**
A: 
- 複数ツールの結果を統合表示
- 外部CIシステムでの結果アップロード
- カスタムレポートの生成

**Q5: 大規模プロジェクトでのパフォーマンスは？**
A: 
- 並列実行による高速化
- 増分スキャンによる効率化
- 除外パターンによる最適化

---

## 🔍 実際の導入事例

### 導入前の課題
- 📊 手動でのセキュリティチェックに時間がかかる
- 🔄 レビューの一貫性が保てない
- 📈 セキュリティインシデントの増加

### 導入後の効果
- ⚡ 自動化による工数削減: 70%
- 🎯 脆弱性発見率の向上: 85%
- 📉 セキュリティインシデント: 50%削減
- 👥 開発者のセキュリティ意識向上

### 導入のポイント
1. **段階的導入**: 一部のプロジェクトから開始
2. **チーム教育**: 開発者への説明と研修
3. **継続的改善**: 設定の見直しと最適化

---

## 🎉 まとめ

### 今日の成果
- ✅ CodeQLの基本概念と動作原理を理解
- ✅ 実際の脆弱性発見・修正を体験
- ✅ 開発プロセスへの組み込み方法を学習
- ✅ 高度な設定とサードパーティツール統合を確認
- ✅ SARIF形式でのレポート活用方法を習得

### 重要なポイント
1. **セキュリティは全員の責任**
   - 開発者全員がセキュリティを意識
   - 自動化によるヒューマンエラーの削減

2. **自動化により継続的な品質向上**
   - プルリクエストでの自動チェック
   - 定期的なスキャン実行
   - 早期発見による効率的な修正

3. **高精度で実用的なツール**
   - 従来ツールより高い検出精度
   - 企業環境での実用性
   - 複数ツールとの統合可能性

### 次のアクションプラン
1. **即座に開始**: 既存プロジェクトでのCodeQL導入
2. **チーム展開**: 開発チーム全体でのトレーニング
3. **継続改善**: 定期的な設定見直しと最適化

**ご清聴ありがとうございました！**

---

*この発表資料は約20分の発表を想定して作成されています。*
*各セクションの時間配分:*
- *導入・概要: 3分*
- *CodeQLの基礎: 4分*
- *実践演習: 5分*
- *高度な設定: 3分*
- *DevSecOps: 3分*
- *質疑応答: 2分*